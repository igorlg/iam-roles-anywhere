AWSTemplateFormatVersion: "2010-09-09"
Description: IAM Roles Anywhere - Host Stack

Parameters:
  Hostname:
    Type: String
    Description: Host identifier (becomes CN in certificate)
    AllowedPattern: "^[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]$"
    MinLength: 2
    MaxLength: 63

  SSMPrefix:
    Type: String
    Default: /iam-ra
    Description: SSM Parameter Store prefix (must match rootca/iamra stacks)

  # Dynamic SSM parameter references - resolved from previous stacks
  TrustAnchorArn:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /iam-ra/trust-anchor-arn
    Description: SSM Parameter containing the Trust Anchor ARN (from iamra stack)

  CertificateIssuerArn:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /iam-ra/certificate-issuer-arn
    Description: SSM Parameter containing the Certificate Issuer Lambda ARN (from iamra stack)

  CAMode:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /iam-ra/ca-mode
    Description: SSM Parameter containing the CA mode (from rootca stack)

  PCAArn:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /iam-ra/pca-arn
    Description: SSM Parameter containing the PCA ARN (from rootca stack)

  SessionDuration:
    Type: Number
    Default: 3600
    MinValue: 900
    MaxValue: 43200
    Description: IAM session duration in seconds

  CertificateValidityDays:
    Type: Number
    Default: 365
    MinValue: 1
    MaxValue: 3650
    Description: Host certificate validity in days

  PolicyArns:
    Type: CommaDelimitedList
    Default: ""
    Description: Comma-separated list of managed policy ARNs to attach

Outputs:
  RoleArn:
    Description: IAM Role ARN for this host
    Value: !GetAtt HostRole.Arn

  ProfileArn:
    Description: IAM Roles Anywhere Profile ARN
    Value: !GetAtt HostProfile.ProfileArn

  CertificateSecretArn:
    Description: Secrets Manager secret ARN for certificate
    Value: !Ref CertificateSecret

  PrivateKeySecretArn:
    Description: Secrets Manager secret ARN for private key
    Value: !Ref PrivateKeySecret

  CertificateSecretName:
    Description: Secrets Manager secret name for certificate
    Value: !Sub "${SSMPrefix}-hosts/${Hostname}/certificate"

  PrivateKeySecretName:
    Description: Secrets Manager secret name for private key
    Value: !Sub "${SSMPrefix}-hosts/${Hostname}/private-key"

  Hostname:
    Description: Hostname (certificate CN)
    Value: !Ref Hostname

  TrustAnchorArn:
    Description: Trust Anchor ARN
    Value: !Ref TrustAnchorArn

  Region:
    Description: AWS Region
    Value: !Ref AWS::Region

Conditions:
  UsePCA: !Or
    - !Equals [!Ref CAMode, "pca-create"]
    - !Equals [!Ref CAMode, "pca-existing"]
  UseSelfManagedCA: !Equals [!Ref CAMode, "self-managed"]
  HasPolicies: !Not [!Equals [!Join ["", !Ref PolicyArns], ""]]

Resources:
  # ===========================================
  # IAM Role for Host
  # ===========================================

  HostRole:
    Type: AWS::IAM::Role
    Properties:
      MaxSessionDuration: !Ref SessionDuration
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: rolesanywhere.amazonaws.com
            Action:
              - sts:AssumeRole
              - sts:TagSession
              - sts:SetSourceIdentity
            Condition:
              StringEquals:
                aws:PrincipalTag/x509Subject/CN: !Ref Hostname
              ArnEquals:
                aws:SourceArn: !Ref TrustAnchorArn
      ManagedPolicyArns: !If
        - HasPolicies
        - !Ref PolicyArns
        - !Ref AWS::NoValue
      Policies:
        - PolicyName: BasePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: AllowGetCallerIdentity
                Effect: Allow
                Action:
                  - sts:GetCallerIdentity
                Resource: "*"
              - Sid: AllowECRAuth
                Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: "*"
              - Sid: AllowECRPull
                Effect: Allow
                Action:
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                Resource: !Sub "arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/*"

  # ===========================================
  # IAM Roles Anywhere Profile
  # ===========================================

  HostProfile:
    Type: AWS::RolesAnywhere::Profile
    Properties:
      Name: !Sub "${Hostname}-profile"
      Enabled: true
      DurationSeconds: !Ref SessionDuration
      RoleArns:
        - !GetAtt HostRole.Arn

  # ===========================================
  # Custom Resource - Certificate Issuer
  # Uses shared Lambda from iamra stack
  # Returns Certificate and PrivateKey via Data
  # ===========================================

  CertificateIssuerCustomResource:
    Type: Custom::CertificateIssuer
    Properties:
      ServiceToken: !Ref CertificateIssuerArn
      Hostname: !Ref Hostname
      CAMode: !Ref CAMode
      PCAArn: !If [UsePCA, !Ref PCAArn, ""]
      ValidityDays: !Ref CertificateValidityDays
      # Self-managed CA credentials (resolved at deploy time via {{resolve:...}} syntax)
      CAPrivateKey: !If
        - UseSelfManagedCA
        - !Sub "{{resolve:secretsmanager:${SSMPrefix}/ca-private-key}}"
        - ""
      CACertificate: !If
        - UseSelfManagedCA
        - !Sub "{{resolve:ssm:${SSMPrefix}/ca-certificate}}"
        - ""

  # ===========================================
  # Secrets Manager - Host Certificate & Key
  # ===========================================

  CertificateSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${SSMPrefix}-hosts/${Hostname}/certificate"
      Description: !Sub "IAM Roles Anywhere certificate for ${Hostname}"
      SecretString: !GetAtt CertificateIssuerCustomResource.Certificate

  PrivateKeySecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${SSMPrefix}-hosts/${Hostname}/private-key"
      Description: !Sub "IAM Roles Anywhere private key for ${Hostname}"
      SecretString: !GetAtt CertificateIssuerCustomResource.PrivateKey

  # ===========================================
  # SSM Parameters - Host Configuration
  # ===========================================

  HostRoleArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub "${SSMPrefix}/hosts/${Hostname}/role-arn"
      Description: !Sub "IAM Role ARN for ${Hostname}"
      Value: !GetAtt HostRole.Arn

  HostProfileArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub "${SSMPrefix}/hosts/${Hostname}/profile-arn"
      Description: !Sub "IAM Roles Anywhere Profile ARN for ${Hostname}"
      Value: !GetAtt HostProfile.ProfileArn

  HostTrustAnchorArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub "${SSMPrefix}/hosts/${Hostname}/trust-anchor-arn"
      Description: !Sub "Trust Anchor ARN for ${Hostname}"
      Value: !Ref TrustAnchorArn

  HostRegionParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub "${SSMPrefix}/hosts/${Hostname}/region"
      Description: !Sub "AWS Region for ${Hostname}"
      Value: !Ref AWS::Region

  HostCertificateSecretArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub "${SSMPrefix}/hosts/${Hostname}/certificate-secret-arn"
      Description: !Sub "SecretsManager ARN for ${Hostname} 's Certificate"
      Value: !Ref CertificateSecret

  HostPrivateKeySecretArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub "${SSMPrefix}/hosts/${Hostname}/private-key-secret-arn"
      Description: !Sub "SecretsManager ARN for ${Hostname} 's Private Key"
      Value: !Ref PrivateKeySecret

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Host Configuration
        Parameters:
          - Hostname
      - Label:
          default: SSM Parameter References (from rootca/iamra stacks)
        Parameters:
          - SSMPrefix
          - TrustAnchorArn
          - CertificateIssuerArn
          - CAMode
          - PCAArn
      - Label:
          default: Certificate Settings
        Parameters:
          - CertificateValidityDays
      - Label:
          default: IAM Configuration
        Parameters:
          - SessionDuration
          - PolicyArns

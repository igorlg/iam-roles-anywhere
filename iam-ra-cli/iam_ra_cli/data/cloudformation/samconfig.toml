# SAM CLI Configuration
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-config.html
#
# Usage:
#   sam build --config-env <env>
#   sam deploy --config-env <env>
#
# Available environments:
#   - rootca: Root CA setup (ACM PCA or self-managed CA)
#   - iamra: IAM Roles Anywhere setup (Trust Anchor)
#   - host: Per-host deployment (IAM Role, Profile, Certificate)
#
# Workflow:
#   1. Deploy rootca stack first (creates CA):
#      sam build --config-env rootca
#      sam deploy --config-env rootca --parameter-overrides PCAArn=self-managed
#      # Or for existing PCA: PCAArn=arn:aws:acm-pca:...
#      # Or for new PCA: PCAArn=""
#
#   2. Deploy iamra stack (creates Trust Anchor):
#      sam build --config-env iamra
#      sam deploy --config-env iamra
#
#   3. For each host, deploy host stack:
#      sam deploy --config-env host \
#        --stack-name iam-ra-host-<hostname> \
#        --parameter-overrides Hostname=<hostname>

version = 0.1

# =============================================================================
# Root CA Stack - Certificate Authority setup (SAM with Lambda for self-managed)
# =============================================================================
# PCAArn parameter determines mode:
#   - "self-managed": Lambda generates self-signed CA (recommended for <40 hosts)
#   - "" (empty): Create new ACM Private CA ($400/month)
#   - "<arn>": Use existing ACM Private CA

[rootca.global.parameters]
template_file = "account-rootca-stack.yaml"
stack_name = "iam-ra-rootca"
s3_prefix = "iam-ra-rootca"
region = "ap-southeast-2"
# profile = "your-aws-profile"
capabilities = "CAPABILITY_NAMED_IAM"
confirm_changeset = true
resolve_s3 = true
cached = true
parallel = true
lint = true

[rootca.deploy.parameters]
template_file = ".aws-sam/build/rootca/template.yaml"

[rootca.build.parameters]
build_dir = ".aws-sam/build/rootca/"

# =============================================================================
# IAM Roles Anywhere Stack - Trust Anchor setup (plain CloudFormation)
# =============================================================================
# Creates Trust Anchor using CA configuration from rootca stack (via SSM).
# Must be deployed AFTER rootca stack.

[iamra.global.parameters]
template_file = "account-iamra-stack.yaml"
stack_name = "iam-ra-account"
s3_prefix = "iam-ra-account"
region = "ap-southeast-2"
# profile = "your-aws-profile"
capabilities = "CAPABILITY_NAMED_IAM"
confirm_changeset = true
resolve_s3 = true
cached = true
parallel = true
lint = true

[iamra.deploy.parameters]
template_file = ".aws-sam/build/iamra/template.yaml"

[iamra.build.parameters]
build_dir = ".aws-sam/build/iamra/"

# =============================================================================
# Host Stack - Per-host deployment (plain CloudFormation, no Lambda)
# =============================================================================
# Note: For host deployments, override the stack_name on the command line:
#   sam deploy --config-env host --stack-name iam-ra-host-myhostname
#
# Required parameter overrides:
#   Hostname=<hostname>
#
# No build step required - uses shared Lambda from iamra stack.

[host.global.parameters]
template_file = "host-stack.yaml"
stack_name = "iam-ra-host"
s3_prefix = "iam-ra-host"
region = "ap-southeast-2"
# profile = "your-aws-profile"
capabilities = "CAPABILITY_NAMED_IAM"
confirm_changeset = true
resolve_s3 = true
lint = true

[host.deploy.parameters]
template_file = "host-stack.yaml"

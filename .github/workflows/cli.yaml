# CLI - Test Python CLI independently
#
# Runs:
# - pytest with coverage
# - Type checking (mypy)
# - Linting (ruff)
# - Verifies CLI loads

name: CLI

on:
  push:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'

jobs:
  test:
    name: Python Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Setup Python
        run: uv python install

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest tests/ -v --cov=src/iam_ra_cli --cov-report=xml

      - name: Type check
        run: uv run mypy src/iam_ra_cli --ignore-missing-imports

      - name: Lint
        run: uv run ruff check src/iam_ra_cli

      - name: Verify CLI loads
        run: uv run iam-ra --help

  # Ensure the Nix package also builds correctly
  nix-build:
    name: Nix Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build CLI
        run: nix build .#iam-ra-cli --print-build-logs

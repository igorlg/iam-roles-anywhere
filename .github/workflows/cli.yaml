# CLI - Test Python CLI independently
#
# PLACEHOLDER: This workflow will be expanded to:
# - Run pytest with coverage
# - Run type checking (mypy)
# - Run linting (ruff)
# - Test CLI commands in isolation (mocked AWS)
#
# For now, it only runs basic Python checks.

name: CLI

on:
  push:
    paths:
      - 'iam-ra-cli/**'
      - '!iam-ra-cli/iam_ra_cli/data/cloudformation/**'
  pull_request:
    paths:
      - 'iam-ra-cli/**'
      - '!iam-ra-cli/iam_ra_cli/data/cloudformation/**'

jobs:
  test:
    name: Python Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: iam-ra-cli

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Setup Python
        run: uv python install

      - name: Install dependencies
        run: uv sync --all-extras

      # TODO: Add pytest once tests are written
      # - name: Run tests
      #   run: uv run pytest --cov=iam_ra_cli --cov-report=xml

      # TODO: Add type checking
      # - name: Type check
      #   run: uv run mypy iam_ra_cli

      # TODO: Add linting
      # - name: Lint
      #   run: uv run ruff check iam_ra_cli

      - name: Verify CLI loads
        run: uv run iam-ra --help

  # Ensure the Nix package also builds correctly
  nix-build:
    name: Nix Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build CLI
        run: nix build .#iam-ra-cli --print-build-logs

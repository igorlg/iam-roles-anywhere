# Release - Version bump and artifact generation on main
#
# Triggered when PRs are merged to main.
# Uses conventional commits to determine version bump.
# Creates GitHub releases and publishes to FlakeHub.
#
# Version tracking:
#   - VERSION file: single source of truth
#   - iam-ra-cli/pyproject.toml: updated by release-please
#   - Both are kept in sync automatically

name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  id-token: write  # Required for FlakeHub

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # Build and verify on Linux (both architectures)
  build-linux:
    name: Build Linux (${{ matrix.arch }})
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: aarch64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build CLI
        run: nix build .#iam-ra-cli --print-build-logs

      - name: Verify CLI runs
        run: |
          ./result/bin/iam-ra --version
          ./result/bin/iam-ra --help

      # Note: The Nix-built CLI is NOT a standalone binary.
      # It's a wrapper script that requires Nix store paths.
      # Users should install via: nix run github:owner/iam-roles-anywhere#iam-ra-cli
      # or add to their flake inputs.
      #
      # For standalone binaries, we would need PyInstaller/Nuitka,
      # which is out of scope for now.

  # Placeholder for Darwin builds (requires self-hosted runners or macOS runners)
  build-darwin:
    name: Build Darwin (${{ matrix.arch }})
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest  # Placeholder - would need macos-latest or self-hosted
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    steps:
      - name: Darwin build placeholder
        run: |
          echo "Darwin builds require macOS runners or cross-compilation."
          echo "For now, Darwin users should install via Nix:"
          echo "  nix run github:owner/iam-roles-anywhere#iam-ra-cli"
          echo ""
          echo "To enable Darwin builds:"
          echo "  1. Use macos-latest runners (x86_64 only)"
          echo "  2. Use self-hosted aarch64-darwin runners"
          echo "  3. Or implement cross-compilation"

  # Publish to FlakeHub
  flakehub:
    name: Publish to FlakeHub
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Publish to FlakeHub
        uses: DeterminateSystems/flakehub-push@main
        with:
          visibility: public
          tag: ${{ needs.release-please.outputs.tag_name }}

  # Create release summary
  release-summary:
    name: Release Summary
    needs: [release-please, build-linux, flakehub]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Release ${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Via Nix (recommended):**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "nix run github:${{ github.repository }}#iam-ra-cli -- --help" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Via FlakeHub:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "nix run flakehub:${{ github.repository }}#iam-ra-cli -- --help" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**As flake input:**" >> $GITHUB_STEP_SUMMARY
          echo '```nix' >> $GITHUB_STEP_SUMMARY
          echo 'inputs.iam-roles-anywhere.url = "github:${{ github.repository }}/${{ needs.release-please.outputs.tag_name }}";' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
